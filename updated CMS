#include <stdio.h>
#include <string.h>
#include <stdlib.h>

struct contact{
	char name[50];
	char phone[20];
	char email[50];
	char address[100];
};

struct contact *con = NULL; 
int count = 0;
int capacity = 0;

void AddContact();
void UpdateContact();
void ViewContact();
void DelContact();
void SearchContact();
void SaveToFile();
void LoadToFile();


int isValidEmail(char *email) {
	int i;
	for(i=0; email[i]; i++){
		if(email[i]=='@') return 1;
	}
	return 0;
}


int isValidPhone(char *phone) {
	int i;
	for(i=0; phone[i]; i++){
		if(phone[i]<'0' || phone[i]>'9'){
			return 0;
		} 
	}
	return (i>0);
}


void ensureCapacity() {
	if(count >= capacity){
		capacity = (capacity==0)? 2 : capacity*2;
		con = realloc(con, capacity * sizeof(struct contact));
		if(!con){
			printf("Memory allocation failed!\n");
			exit(1);
		}
	}
}


int toLowerChar(char c) {
    if(c >= 'A' && c <= 'Z') {
        return c + 32;
    }
    return c;
}

int contains(char str[50], char substr[50]){
    int lenStr = strlen(str);
    int lenSub = strlen(substr);
    int i, j;
    for(i = 0; i <= lenStr - lenSub; i++){
        int match = 1;
        for(j = 0; j < lenSub; j++){
            if(toLowerChar(str[i + j]) != toLowerChar(substr[j])){
                match = 0;
                break;
            }
        }
        if(match) return 1;
    }
    return 0;
}

int main(){
	LoadToFile();
	int choice;
	do{
	printf("=============================================================================================\n");
	printf("\t        Contact Management System\n");
	printf("=============================================================================================\n");
	
	printf("Menu:\n");
	printf("1. Add Contact\n");
	printf("2. Update Existing Contact\n");
	printf("3. View Contact\n");
	printf("4. Delete Contact\n");
	printf("5. Search Contact\n");
	printf("6. Exit\n");
	printf("\n");
	printf("Please enter your choice:");
	scanf("%d", &choice);
	getchar();
	
	printf("\n");
	
	switch(choice){
		case 1: AddContact(); break;
		case 2: UpdateContact(); break;
		case 3: ViewContact(); break;
		case 4: DelContact(); break;
		case 5: SearchContact(); break;
		case 6: printf("Exiting program...\n"); break;
		
		default:
			printf("Invalid Choice!");
			}
		}while(choice != 6); 
	
	free(con);
	return 0; 
}

void SaveToFile(){
	FILE *fp = fopen("record.txt", "w");
	
	if (fp == NULL){
		printf("Error opening file...\n");
		return;
	}
	int i;
	for(i=0 ; i<count ; i++){
		fprintf(fp, "%s\n%s\n%s\n%s\n", con[i].name, con[i].phone, con[i].email, con[i].address);
    }
	
	fclose(fp);
}

void LoadToFile(){
	FILE *fp = fopen("record.txt", "r");
	if(fp == NULL){
		printf("You do not have any contacts saved...\n");
		return;
	}

	count = 0;
	int i;
	while(1){
		ensureCapacity();
		
		if(fgets(con[count].name, sizeof(con[count].name), fp) == NULL) break;
		con[count].name[strcspn(con[count].name,"\n")] = 0;

		if(fgets(con[count].phone, sizeof(con[count].phone), fp) == NULL) break;
		con[count].phone[strcspn(con[count].phone,"\n")] = 0;

		if(fgets(con[count].email, sizeof(con[count].email), fp) == NULL) break;
		con[count].email[strcspn(con[count].email,"\n")] = 0;

		if(fgets(con[count].address, sizeof(con[count].address), fp) == NULL) break;
		con[count].address[strcspn(con[count].address,"\n")] = 0;

		count++;
	}

	fclose(fp);
}

void AddContact(){
	ensureCapacity();
	printf("---------------------------------------------------------------------------------------------\n");
	printf("Adding details:\n");
	printf("\n");
	
	printf("Enter Name:");
	fgets(con[count].name,sizeof(con[count].name),stdin);
	con[count].name[strcspn(con[count].name,"\n")]=0;
	
	do{
		printf("Enter Phone Number:");
		fgets(con[count].phone,sizeof(con[count].phone),stdin);
		con[count].phone[strcspn(con[count].phone,"\n")]=0;
		if(!isValidPhone(con[count].phone)) {
			printf("Invalid phone! Try again.\n");
		}
	}while(!isValidPhone(con[count].phone));
	
	do{
		printf("Enter Email:");
		fgets(con[count].email,sizeof(con[count].email),stdin);
		con[count].email[strcspn(con[count].email,"\n")]=0;
		if(!isValidEmail(con[count].email)) {
			printf("Invalid email! Must contain '@'. Try again.\n");
		}
	}while(!isValidEmail(con[count].email));
	
	printf("Enter Address:");
	fgets(con[count].address,sizeof(con[count].address),stdin);
	con[count].address[strcspn(con[count].address,"\n")]=0;
	
	count++;
	printf("\n");
	printf("Contact Successfully Added...\n");
	printf("\n");
	printf("---------------------------------------------------------------------------------------------\n");
	
	SaveToFile();
	printf("\n");
}

void UpdateContact(){
	if(count == 0){
		printf("Error displaying contacts...\n");
		return;
	}
	
	ViewContact();
	int index, choice;
	printf("Enter the number of contact to update:");
	scanf("%d", &index);
	getchar();
	
	index--;
	
	if(index < 0 || index >=count){
		printf("Invalid Choice...\n");
		return;
	}
	
	printf("What do you want to update?\n");
	printf("1. Name\n");
	printf("2. Phone Number\n");
	printf("3. Email\n");
	printf("4. Address\n");
	printf("5. Exit\n");
	printf("\n");
	printf("Enter your choice:");
	scanf("%d", &choice);
	getchar();
	
	if(choice == 1){
		printf("Enter New Name : ");
		fgets(con[index].name, sizeof(con[index].name), stdin);
		con[index].name[strcspn(con[index].name , "\n")] = 0;
	}
	
	else if(choice == 2){
		do{
			printf("Enter New Phone Number : ");
			fgets(con[index].phone, sizeof(con[index].phone), stdin);
			con[index].phone[strcspn(con[index].phone , "\n")] = 0;
			if(!isValidPhone(con[index].phone)) printf("Invalid phone! Try again.\n");
		}while(!isValidPhone(con[index].phone));
	}
	
	else if(choice == 3){
		do{
			printf("Enter New Email : ");
			fgets(con[index].email, sizeof(con[index].email), stdin);
			con[index].email[strcspn(con[index].email , "\n")] = 0;
			if(!isValidEmail(con[index].email)) printf("Invalid email! Must contain '@'. Try again.\n");
		}while(!isValidEmail(con[index].email));
	}
	
	else if(choice == 4){
		printf("Enter New Address : ");
		fgets(con[index].address, sizeof(con[index].address), stdin);
		con[index].address[strcspn(con[index].address , "\n")] = 0;
	}
	
	else if(choice == 5){
		printf("Exiting...\n");
		return;
	}
	
	else{
		printf("Invalid Option...\n");
		return;
	}
	
	SaveToFile();
	printf("Contact Updated Successfully...\n");
}

void ViewContact(){
	if(count == 0){
		printf("You have no contacts saved...\n");
		return;
	}
	
	printf("---------------------------------------------------------------------------------------------\n");
	printf("Saved Contacts:\n");
	printf("\n");
	int i;
	printf("%-5s %-20s %-15s %-25s %-30s\n","No.","Name","Phone","Email","Address");
	printf("---------------------------------------------------------------------------------------------\n");
	for(i=0 ; i<count ; i++){
		printf("%-5d %-20s %-15s %-25s %-30s\n",i+1,con[i].name,con[i].phone,con[i].email,con[i].address);
	}
	printf("\n");
}

void DelContact(){
	if(count == 0){
		printf("No contants to delete...\n");
		return;
	}
	
	int index, i;
	ViewContact();
	printf("Enter the number you want to delete:");
	scanf("%d", &index);
	getchar();
	
	if(index < 1 || index>count){
		printf("Invalid number...");
		return;
	}
	for(i = index-1 ; i < count-1 ; i++){
		con[i]=con[i+1];
	}
	count--;
	
	SaveToFile();
	printf("\n");
	printf("Contact Deleted Successfully\n");
	printf("---------------------------------------------------------------------------------------------\n");
}

void SearchContact(){
	char SearchName[50];
	int i;
	printf("=============================================================================================\n");
	printf("Enter the name you want to search:");
	fgets(SearchName, sizeof(SearchName), stdin);
	SearchName[strcspn(SearchName, "\n")] = 0;
	
	int found = 0;
	for(i = 0 ; i < count ; i++){
		if (contains(con[i].name, SearchName)){
			printf("\n");
			printf("Contact Found! \n");
			printf("\n");
			printf("Name : %s\n", con[i].name);
			printf("Phone Number : %s\n", con[i].phone);
			printf("Email : %s\n", con[i].email);
			printf("Address : %s\n", con[i].address);
			found = 1;
		}
	}
	if (!found){
		printf("Contact not found...\n");
	}
	printf("---------------------------------------------------------------------------------------------\n");
}
